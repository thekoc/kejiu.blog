---
title: 'Launchd 简明指南 -  Mac 上最强大的后台管理工具'
date: '2023-08-12'
tags: ['macos', 'launchd', 'apple']
summary: 'Launchd 简明指南 -  Mac 上最强大的后台管理工具'
images: []
authors: ['default']
draft: true
---

## 前言

之前用过几次 launchd 来管理一些后台程序，似乎可以运行，却不始终求甚解。心中也一直有一些问题，比如 launchd, crontab，systemd 是什么关系？它接受哪些命令，起什么作用？配置文件到底怎么写，有哪些选项？

最近恰好有较全面地了解了一下 ，于是在此处纪录一下，以便日后查阅，也希望帮助到有需要的人。

## launchd 到底是什么? 

简单来说，launchd 是一个 macOS 上的后台服务管理进程。例如键盘监听，文件系统，驱动程序，iCloud同步等等等服务都是由他启动和管理的。但是它不仅仅是一个后台服务管理进程（类比 Supervisord 和 Crontab），它是一个 init 程序，是系统启动后运行的第一个进程（PID 为 1），因此也就在系统中有着特殊的地位。如今 Linux 系统中较为流行的 init 程序 systemd 也是受到 launchd 启发而设计的。

作为一个系统级进程，它本身不会带来什么性能损耗，还有着非常强大的功能和配置选项。唯一的缺点就是——有些复杂。XML 格式的配置文件，繁杂的功能项（三十多项可选配置），再加上官方在 2016 年左右重写了 launchctl，更改了一些用户接口，这都在增加 launchd 的理解难度。

除了这个“小小”的缺点外，可以说launchd 是居家旅行必备程序了。

## 基本概念

简单来说，launchd 会在启动时扫描特定的文件夹，读取相应的配置文件，根据当前的上下文，决定是否需要立即启动，以什么权限启动，并且将这些程序纳入自己的管理范围。这些都是开机后自动完成的。

作为用户，如果我们想和 launchd 交互，例如禁用或者启用某些服务，或者查看当前正在运行的服务等，就需要用到 launchctl 这个命令行工具。而如果我们想创建自己的后台服务程序，就需要自行编写配置文件，根据使用目的将它放置在正确的路径中。

需要注意的是，根据苹果的设计，launchd 有“域”（domain）的概念。“域”是一个树状结构，系统的域处于根节点，属于用户的后台程序会运行在与用户绑定的子节点域中。关于这个设计，会在后文中讨论。

## 启动步骤

为了便于理解，一个不太准确的 launchd 启动步骤是这样的：

1. 机器开机，内核启动。
2. 内核加载 launchd。
3. launchd 读取 `/System/Library/LaunchDaemons` 和 `/Library/LaunchDaemons` 中的 `plist` 文件，运行满足条件的进程（并不是所有的进程都会被马上执行）。
4. 启动用户登录窗口（也就是我们输入密码的页面）。
5. 用户通过图形页面登录系统。
6. launchd 读取 `/System/Library/LaunchAgents`，`/Library/LaunchAgents`和 `~/Library/LaunchAgents` 中的配置文件，并且启动满足条件的进程。
7. 用户使用过程中，手动输入 `launchctl load` 命令（已被标记为废弃，下文详细讨论）让 launchd 主动加载配置文件。

## 配置文件解析

配置文件是一个以 `.plist` 结尾的文件，我们通过配置文件来告诉 launchd 程序何时启动，启动后做些什么。

配置文件的格式和参数近年来发生了一些改变，所以网络上（甚至官方）曾经的教程都会有不准确的地方。所幸 macOS 系统自带了及时更新的[文档](x-man-page://launchd.plist)，其中详细描述了配置文件可选的各种值以及作用。你可以通过在命令行中输入 `man launchd.plist` 来查看。
![](Screenshot%202023-08-22%20at%2010.19.17%20AM.png)
### 存放位置

以下表格说明了存放在不同位置中的配置文件的区别。

|文件夹|用途|
|---|---|
|/系统/资源库/LaunchDaemons|Apple 提供的系统守护进程|
|/系统/资源库/LaunchAgents|Apple 提供的基于每个用户且所有用户适用的代理|
|/资源库/LaunchDaemons|第三方系统守护进程|
|/资源库/LaunchAgents|基于每个用户且所有用户适用的第三方代理|
|~/资源库/LaunchAgents|仅适用于登录用户的第三方代理|

### 基本结构

下面是一个示例：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.example.touchsomefile</string>
    <key>ProgramArguments</key>
    <array>
        <string>touch</string>
        <string>/tmp/helloworld</string>
    </array>
    <key>StartInterval</key>
    <integer>300</integer>
</dict>
</plist>
```

这个配置文件包含了三个主要的值：

1. `Label` 程序的标识符，必须是唯一的。
2. `ProgramArguments`  程序的路径和参数。
3. `StartInterval` 程序重复运行的间隔。

这个例子中，程序标识符为 `com.example.touchsomefile`，运行的命令为 `touch /tmp/helloworld`，每隔 `300` 秒便会执行一次。

### KeepAlive

如果你的程序是需要一直运行的后台程序，可以把 `StartInterval` 替换成 `KeepAlive`。
```xml
<key>KeepAlive</key>
<true/>
```

当你的程序退出后，launchd 会自动重新启动。默认情况下重启的间隔不能少于 10 秒，这个间隔可以用 `ThrottleInterval` 键去修改。

`KeepAlive` 除了 `true` 以外，还可以设置为很多值，例如 `SuccessfulExit`, `PathState`, `OtherJobEnabled` 等。注意 `NetworkState` 现在已经被废弃。详细的讨论可参考官方说明。
### 日历时间

类似 Crontab，launchd 也可以配置程序按照日历时间来运行，例如每周一下午三点。只需要把 `StartInterval` 更改成 `StartCalendarInterval` 即可。

```xml
    <key>StartCalendarInterval</key>
    <dict>
        <key>Minute</key>
        <integer>45</integer>
        <key>Hour</key>
        <integer>13</integer>
        <key>Day</key>
        <integer>7</integer>
        <key>Weekday</key>
        <integeer>1</integer>
        <key>Month</key>
        <integeer>12</integer>
    </dict>

```

不是所有键都必须填写，例如把 `Hour` 键去掉，就等同于 Crontab 中的通配符 (`*`），在满足其他条件的前提下每小时都会运行一次。

### 监听文件变化

除了按照时间间隔和日历外，launchd 也支持监听文件变化，例如加入`WatchPaths` 这个键后：
```xml
    <key>WatchPaths</key>
    <array>
        <string>/etc/hostconfig</string>
    </array>
```

程序便会在此文件发生变化后启动。

### 其他启动条件

launchd 还支持很多其他启动条件，有兴趣可以查看官方[相关文档](https://developer.apple.com/library/archive/technotes/tn2083/_index.html#//apple_ref/doc/uid/DTS10003794-CH1-SUBSECTION37)。

|Criterion|Property List Key|Introduced|
|---|---|---|
|change to file system object|WatchPaths|10.4|
|non-empty directory|QueueDirectories|10.4|
|file system mount|StartOnMount|10.5|
|periodic|StartInterval|10.4|
|wall time|StartCalendarInterval|10.4|
|Mach message |MachServices|10.5|
|connection to a stream socket|Sockets|10.4|
|traffic to a datagram port|Sockets|10.4|

### 日志文件

如果你需要记录运行日志，可以把标准输出/错误输出重定向到文件，只需加入 `StandardOutPath` 和 `StandardErrorPath` 这两个键：

```xml
    <key>StandardOutPath</key>
    <string>/var/log/myjob.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/myjob.log</string>
```

### 其他配置

此外，也通过 `UserName` 或者 `UID` 来指定运行程序的用户（注意，这可能会涉及到权限问题）。通过 `WorkingDirectory` 来配置工作目录。通过 `RootDirectory` 来配置根目录。由于篇幅本章不详细展开，请查阅官方的 Mannual 文档。

## Launchctl

虽然刚刚一直在说 launchd，实际上和我们打交道其实是命令行工具 `launchctl`，它们就像 Linux 中的 systemd 和 systemctl，一个是后端程序，一个是用户用来和后端交互的前端命令行页面。比如，launchd 负责管理后台进程，如果我们要手动禁止/启用/重启/查看后台进程，就需要用到 `launchctl` 命令了。
### 旧方法 vs 新方法
在 2016 年左右大幅改动了 launchd 的命令，传统的命令 

```
    launchctl load -w <plist-file-path>
```

被标注为不建议继续使用，取而代之的是

```
    launchctl bootstrap <domian-target> <plist-file-path>
```

苹果为什么要

### 
# 

## 参考资料
1. [Man Page](https://ss64.com/osx/launchctl.html)
2. [CheatSheet](https://gist.github.com/masklinn/a532dfe55bdeab3d60ab8e46ccc38a68)
3. [LAUNCHCTL 2.0 SYNTAX](https://babodee.wordpress.com/2016/04/09/launchctl-2-0-syntax/)
4. [A Simple Launchd Tutorial](https://medium.com/@chetcorcos/a-simple-launchd-tutorial-9fecfcf2dbb3)
5. [Script management with launchd in Terminal on Mac](https://support.apple.com/en-hk/guide/terminal/apdc6c1077b-5d5d-4d35-9c19-60f2397b2369/2.13/mac/13.0)
6. [Daemons and Services Programming Guide](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html#//apple_ref/doc/uid/10000172i-SW1-SW1)
7. [Daemons and Agents](https://developer.apple.com/library/archive/technotes/tn2083/_index.html#//apple_ref/doc/uid/DTS10003794)
8. [What is service-target](https://developer.apple.com/forums/thread/16206)
9.  [launchd: Confusion on semantics of bootstrap and bootout etc. after reading manual pages](https://apple.stackexchange.com/questions/366281/launchd-confusion-on-semantics-of-bootstrap-and-bootout-etc-after-reading-manu)